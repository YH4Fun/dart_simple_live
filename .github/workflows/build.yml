name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Fix dependencies conflict
        run: |
          cd simple_live_app
          sed -i 's/intl: \^0\.[0-9.]\+/intl: 0.19.0/g' pubspec.yaml
          echo "" >> pubspec.yaml
          echo "dependency_overrides:" >> pubspec.yaml
          echo "  intl: 0.19.0" >> pubspec.yaml
          rm -f pubspec.lock

      - name: Fix build.gradle.kts
        run: |
          cd simple_live_app/android/app
          cat > build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application")
              id("kotlin-android")
              id("dev.flutter.flutter-gradle-plugin")
          }

          android {
              namespace = "com.xyaod.simple_live"
              compileSdk = flutter.compileSdkVersion
              ndkVersion = flutter.ndkVersion

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_1_8
                  targetCompatibility = JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = JavaVersion.VERSION_1_8.toString()
              }

              defaultConfig {
                  applicationId = "com.xyaod.simple_live"
                  minSdk = flutter.minSdkVersion
                  targetSdk = flutter.targetSdkVersion
                  versionCode = 1
                  versionName = "1.0.0"
              }

              buildTypes {
                  release {
                      signingConfig = signingConfigs.getByName("debug")
                  }
              }
          }

          flutter {
              source = "../.."
          }

          dependencies {
              implementation("com.google.android.material:material:1.9.0")
          }
          EOF

      - name: Install dependencies
        run: |
          cd simple_live_app
          flutter pub get

      - name: Build Debug APK
        run: |
          cd simple_live_app
          flutter build apk --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: simple-live-apk
          path: simple_live_app/build/app/outputs/flutter-apk/app-debug.apk
